{% extends "base.html" %}

{% block title %}MyTasks - Settings{% endblock %}

{% block content %}
<div class="settings-container">
    <h2>Settings</h2>

    <form id="settingsForm" onsubmit="handleSaveSettings(event)">
        <div class="settings-section">
            <h3>General Settings</h3>
            <div class="form-group">
                <label for="maxActiveTasks">Maximum Active Tasks</label>
                <input type="number" id="maxActiveTasks" value="{{ config.max_active_tasks }}" min="1" required>
                <small>Total number of tasks that can be in "Current" status at once</small>
            </div>
        </div>

        <div class="settings-section">
            <h3>Task Types</h3>
            <div id="taskTypesList">
                {% for type_name, type_config in config.task_types.items() %}
                <div class="task-type-item" data-type-name="{{ type_name }}">
                    <div class="form-group inline">
                        <input type="text" class="type-name" value="{{ type_name }}" placeholder="Type name">
                        <input type="number" class="type-max" value="{{ type_config.max_open }}" min="1" placeholder="Max open">
                        <input type="color" class="type-color" value="{{ type_config.color }}">
                        <button type="button" onclick="removeTaskType(this)" class="btn btn-danger">Remove</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addTaskType()" class="btn">Add Task Type</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Settings</button>
            <a href="/" class="btn">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function addTaskType() {
    const container = document.getElementById('taskTypesList');
    const div = document.createElement('div');
    div.className = 'task-type-item';
    div.innerHTML = `
        <div class="form-group inline">
            <input type="text" class="type-name" placeholder="Type name" value="New Type">
            <input type="number" class="type-max" value="3" min="1" placeholder="Max open">
            <input type="color" class="type-color" value="#4A90E2">
            <button type="button" onclick="removeTaskType(this)" class="btn btn-danger">Remove</button>
        </div>
    `;
    container.appendChild(div);
}

function removeTaskType(button) {
    const item = button.closest('.task-type-item');
    if (item) {
        item.remove();
    }
}

function handleSaveSettings(event) {
    event.preventDefault();

    const maxActiveTasks = parseInt(document.getElementById('maxActiveTasks').value);
    const taskTypes = {};

    document.querySelectorAll('.task-type-item').forEach(item => {
        const name = item.querySelector('.type-name').value.trim();
        const maxOpen = parseInt(item.querySelector('.type-max').value);
        const color = item.querySelector('.type-color').value;

        if (name) {
            taskTypes[name] = {
                max_open: maxOpen,
                color: color
            };
        }
    });

    fetch('/api/config', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            max_active_tasks: maxActiveTasks,
            task_types: taskTypes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Settings saved successfully', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showNotification('Error saving settings: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving settings', 'error');
    });
}

function showNotification(message, type) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification ' + type;
    setTimeout(() => {
        notification.className = 'notification hidden';
    }, 3000);
}
</script>
{% endblock %}
